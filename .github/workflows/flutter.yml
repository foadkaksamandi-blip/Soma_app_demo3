name: Build SOMA Offline Demo

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Ø¯Ø±ÛŒØ§ÙØª Ø³ÙˆØ±Ø³ Ù¾Ø±ÙˆÚ˜Ù‡
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Ù†ØµØ¨ Java 17
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3ï¸âƒ£ Ù†ØµØ¨ Flutter
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'         # Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒ Ù†Ø³Ø®Ù‡ Ø®Ø§Øµ Ù…Ø«Ù„ 3.24.3 Ù‡Ù… Ø¨Ù†ÙˆÛŒØ³ÛŒ
          cache: true

      # 4ï¸âƒ£ Ø³Ø§Ø®Øª ÙØ§ÛŒÙ„ android/local.properties Ø¨Ù‡â€ŒØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø±
      - name: Generate android/local.properties
        run: |
          echo "flutter.sdk=${FLUTTER_HOME}" > android/local.properties
          echo "sdk.dir=${ANDROID_SDK_ROOT}" >> android/local.properties
          echo "Generated android/local.properties:"
          cat android/local.properties

      # 5ï¸âƒ£ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø´â€ŒÙ‡Ø§ Ùˆ Ø¨ÛŒÙ„Ø¯ Ù‚Ø¨Ù„ÛŒ
      - name: Clean Flutter build caches
        run: flutter clean

      # 6ï¸âƒ£ Ø¯Ø±ÛŒØ§ÙØª ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§
      - name: Get Flutter dependencies
        run: flutter pub get

      # 7ï¸âƒ£ Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø­ÛŒØ· (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
      - name: Environment info
        run: flutter doctor -v

      # 8ï¸âƒ£ Ø¨ÛŒÙ„Ø¯ Ù†Ø³Ø®Ù‡ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ (Seller)
      - name: Build Seller APK (debug)
        run: flutter build apk --debug --target=lib/seller_main.dart --split-per-abi

      # 9ï¸âƒ£ Ø¨ÛŒÙ„Ø¯ Ù†Ø³Ø®Ù‡ Ø®Ø±ÛŒØ¯Ø§Ø± (Buyer)
      - name: Build Buyer APK (debug)
        run: flutter build apk --debug --target=lib/buyer_main.dart --split-per-abi

      # ğŸ”Ÿ Ø®Ø±ÙˆØ¬ÛŒ Ú¯Ø±ÙØªÙ† Ø§Ø² ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ø®ØªÙ‡â€ŒØ´Ø¯Ù‡
      - name: Upload APKs
        uses: actions/upload-artifact@v4
        with:
          name: soma_demo_apks
          path: build/app/outputs/flutter-apk/*.apk
